// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ?용???권한
enum UserRole {
  RESEARCHER // ?구??
  BUYER // 구매 ?당??
  SUPPLIER // 공급??
  ADMIN // 관리자
}

// 조직 ???? (?크?페?스 ??)
enum OrganizationRole {
  VIEWER // 조회?가??
  REQUESTER // 견적 ?청 가??
  APPROVER // 견적 ?인 가??
  ADMIN // 조직 관리자
}

// 구독 ?랜 ???
enum SubscriptionPlan {
  FREE // 무료/Beta
  TEAM // ? ?랜
  ORGANIZATION // 조직/Enterprise ?랜
}

// 조직/?크?페?스
model Organization {
  id                String           @id @default(cuid())
  name              String
  description       String?          @db.Text
  plan              SubscriptionPlan @default(FREE) // 구독 ?랜
  planExpiresAt     DateTime? // ?랜 만료??
  maxMembers        Int? // 최? 멤버 ??(?랜??한)
  maxQuotesPerMonth Int? // ?별 최? ?목 리스????
  maxSharedLinks    Int? // 최? 공유 링크 ??
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  // 관?
  members      OrganizationMember[]
  quotes       Quote[]
  templates    QuoteTemplate[]
  inventories  ProductInventory[]
  subscription Subscription? // 구독 ?보
  activityLogs ActivityLog[]
  auditLogs    AuditLog[]

  @@index([name])
  @@index([plan])
}

// 조직 멤버
model OrganizationMember {
  id             String           @id @default(cuid())
  userId         String
  organizationId String
  role           OrganizationRole @default(VIEWER)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  // 관?
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  image         String?
  role          UserRole  @default(RESEARCHER)
  organization  String? // ?거???드 (조직?직접 ?력)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // NextAuth 관?
  accounts Account[]
  sessions Session[]

  // 관?
  quotes              Quote[]
  comparisons         Comparison[]
  favorites           Favorite[]
  searchHistory       SearchHistory[]
  organizationMembers OrganizationMember[]
  workspaceMembers    WorkspaceMember[] // Workspace membership
  reviews             Review[]
  templates           QuoteTemplate[]
  inventories         ProductInventory[]
  inventoryUsage      InventoryUsage[]
  activityLogs        ActivityLog[]
  auditLogs           AuditLog[]

  @@index([email])
  @@index([role])
}

// NextAuth.js v5??한 모델
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ?품 카테고리
enum ProductCategory {
  REAGENT // ?약
  TOOL // 기구
  EQUIPMENT // ?비
  RAW_MATERIAL // 원료(원부자재)
}

// ?품
model Product {
  id                    String                       @id @default(cuid())
  name                  String
  nameEn                String? // ?문?
  description           String?                      @db.Text
  descriptionEn         String?                      @db.Text
  descriptionTranslated String?                      @db.Text // 번역???명 (GPT 번역)
  category              ProductCategory
  brand                 String?
  modelNumber           String?
  catalogNumber         String? // 카탈로그 번호 (Cat.No)
  lotNumber             String? // Lot 번호 (배치 번호) - 원료(원부자재) 포함
  specifications        Json? // ?펙 ?보 (JSON)
  datasheetUrl          String?
  imageUrl              String?
  embedding             Unsupported("vector(1536)")? // 벡터 ?베??(pgvector)
  // 그룹?어 친화???드
  grade                 String? // Grade (HPLC grade, GMP, EP/USP, cell culture tested ??
  specification         String? // 규격/?량 (?? 1mg, 500mL, 0.22um ??
  regulatoryCompliance  String? // 규제/?전 규격 (USP, EP, JP ??

  // 안전·규제 정보 (P1)
  msdsUrl    String? // MSDS/SDS 문서 URL
  safetyNote String? @db.Text // 안전 취급 요약/주의사항

  // 안전 필드 구조화 (P2)
  hazardCodes      Json? // 위험 코드 배열 (예: ["H314", "H290"])
  pictograms       Json? // GHS 피크토그램 배열 (예: ["corrosive", "exclamation"])
  storageCondition String? @db.Text // 보관 조건 (예: "2~8°C 냉장 보관")
  ppe              Json? // 개인보호장비 배열 (예: ["gloves", "goggles"])

  // 원료(원부자재) 전용 필드 (P1)
  coaUrl              String? // COA (Certificate of Analysis) URL
  specSheetUrl        String? // Spec Sheet URL
  pharmacopoeia       String? // 규정/표준 (예: "USP", "EP", "JP", "KP")
  countryOfOrigin     String? // 원산지
  manufacturer        String? // 제조사
  expiryDate          DateTime? // 유효기간

  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  // 관?
  vendors         ProductVendor[]
  comparisons     ComparisonProduct[]
  favorites       Favorite[]
  recommendations ProductRecommendation[] @relation("ProductRecommendations")
  recommendedFor  ProductRecommendation[] @relation("RecommendedProducts")
  searchHistory   SearchHistory[]
  reviews         Review[]
  quoteListItems  QuoteListItem[]
  inventories     ProductInventory[]

  @@index([category])
  @@index([brand])
  @@index([name])
}

// 벤더/공급??
model Vendor {
  id                String    @id @default(cuid())
  name              String
  nameEn            String?
  email             String?
  phone             String?
  website           String?
  country           String?   @default("KR")
  currency          String?   @default("KRW")
  // ?익 모델 관???드
  isPremium         Boolean   @default(false) // ?리미엄 ?랜 ??
  premiumExpiresAt  DateTime? // ?리미엄 만료??
  leadPricePerQuote Float?    @default(0) // 리드??과금 (견적 ?청??
  totalLeads        Int       @default(0) //?리드 ??
  totalRevenue      Float     @default(0) //??익
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // 관?
  products        ProductVendor[]
  quoteResponses  QuoteResponse[]
  billingRecords  VendorBillingRecord[]

  @@index([name])
  @@index([isPremium])
}

// ?품-벤더 관?(가? ?고, ?기 ?보)
model ProductVendor {
  id                String   @id @default(cuid())
  productId         String
  vendorId          String
  price             Float?
  currency          String   @default("KRW")
  priceInKRW        Float? // KRW ?산 가?
  stockStatus       String? // ?고 ?태
  leadTime          Int? // ?기??(???위)
  minOrderQty       Int?
  url               String?
  // ?리미엄 ?출 관??
  isPremiumFeatured Boolean  @default(false) // ?리미엄 추천 ?역 ?출
  premiumPriority   Int      @default(0) // ?리미엄 ?선?위 (?을?록 ?단 ?출)
  lastUpdated       DateTime @default(now())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // 관?
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  vendor  Vendor  @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@unique([productId, vendorId])
  @@index([productId])
  @@index([vendorId])
  @@index([priceInKRW])
  @@index([isPremiumFeatured, premiumPriority])
}

// 비교 ?이?
model Comparison {
  id        String   @id @default(cuid())
  userId    String
  name      String? // 비교 ?트 ?름
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 관?
  user     User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  products ComparisonProduct[]

  @@index([userId])
}

// 비교-?품 관?
model ComparisonProduct {
  id           String   @id @default(cuid())
  comparisonId String
  productId    String
  order        Int // ?렬 ?서
  createdAt    DateTime @default(now())

  // 관?
  comparison Comparison @relation(fields: [comparisonId], references: [id], onDelete: Cascade)
  product    Product    @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([comparisonId, productId])
  @@index([comparisonId])
}

// 그룹?어???목 리스??(기존 Quote 모델 ???되, 개념???목 리스?로 ?장)
model Quote {
  id             String    @id @default(cuid())
  userId         String? // Nullable for guest quotes
  guestKey       String? // Guest key for anonymous access
  organizationId String? // 조직 ?위 리스?인 경우
  workspaceId    String? // Optional workspace association (for gradual migration)
  comparisonId   String? // 비교 ?트 기반 리스?인 경우
  title          String // 리스???목
  description    String?   @db.Text // 리스???명/비고
  status         QuoteStatus @default(PENDING) // 견적 상태 (구매 완료 태그 포함)
  currency       String    @default("KRW") // Currency for quote totals
  totalAmount    Int? // Total amount (sum of line totals)
  vendor         String? // 공급사 이름 (AI 추출)
  confidence     String? // AI 분석 신뢰도 (high, medium, low)
  extractionMethod String? // 추출 방법 (pdf-parse, fallback, ocr-required)
  pdfFileName    String? // 원본 PDF 파일명
  rawText        String?   @db.Text // 추출된 원본 텍스트 (디버깅용)
  // 그룹?어 ?동 ?보
  templateId     String? // ?용???플?ID
  templateType   String? // ?플????(R&D, QC, ?산 ?? - ?위 ?환??
  exportedAt     DateTime? // ?보?기 ?점
  // 버전 관리 (P1)
  version        Int       @default(1) // 버전 번호
  parentQuoteId  String? // 원본 리스트 ID (버전이 있는 경우)
  isSnapshot     Boolean   @default(false) // 스냅샷 여부
  snapshotNote   String?   @db.Text // 스냅샷 메모
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // 관?
  user            User?                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization    Organization?          @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  workspace       Workspace?             @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  template        QuoteTemplate?         @relation(fields: [templateId], references: [id], onDelete: SetNull)
  parentQuote     Quote?                 @relation("QuoteVersions", fields: [parentQuoteId], references: [id], onDelete: SetNull)
  versions        Quote[]                @relation("QuoteVersions") // 버전 리스트
  items           QuoteListItem[] // QuoteItem ???QuoteListItem ?용
  quoteItems      QuoteItem[] // ?거???환??
  vendors         QuoteVendor[] // Vendor information for quote
  vendorRequests  QuoteVendorRequest[] // Vendor quote requests (견적 요청)
  // 기존 ?환?을 ?해 QuoteResponse ?? (?후 ?거 가??
  responses       QuoteResponse[]
  sharedLists     SharedList[] // 공유 링크
  shares          QuoteShare? // Public share configuration
  purchaseRecords PurchaseRecord[] // ?제 구매?역
  rfqToken        QuoteRfqToken? // RFQ email token
  replies         QuoteReply[] // Email-based vendor replies
  inboundEmails   InboundEmail[] // Matched inbound emails

  @@index([userId])
  @@index([guestKey])
  @@index([organizationId])
  @@index([workspaceId])
  @@index([templateId])
  @@index([parentQuoteId])
  @@index([version])
}

// ?목 리스???플?(조직??도?컬럼 ?트)
model QuoteTemplate {
  id             String   @id @default(cuid())
  name           String // ?플??름 (?? "R&D 기본??, "QC ?험??, "?산 ??구매형")
  type           String // ?플????(R&D, QC, PRODUCTION, CUSTOM)
  organizationId String? // 조직??플릿인 경우
  userId         String? // ?용?별 커스? ?플릿인 경우
  description    String?  @db.Text
  // 컬럼 ?정 (JSON)
  columns        Json // ?시??컬럼??서, ?수/?택 ?? ??
  // ?? { columns: [{ key: "lineNumber", label: "Line No.", required: true, order: 1 }, ...] }
  isDefault      Boolean  @default(false) // 기본 ?플???
  isPublic       Boolean  @default(false) // 공개 ?플??? (?른 ?용?도 ?용 가??
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // 관?
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  quotes       Quote[]

  @@index([organizationId])
  @@index([userId])
  @@index([type])
}

// 그룹?어???목 리스???? (기존 QuoteItem???장)
model QuoteListItem {
  id            String   @id @default(cuid())
  quoteId       String
  productId     String? // Nullable for items without existing products
  lineNumber    Int? // Line No. (그룹?어??
  name          String? // Product name (denormalized for draft items)
  brand         String? // Brand (denormalized)
  catalogNumber String? // Catalog number (denormalized)
  unit          String?  @default("ea") // Unit (ea, mL, g, etc.)
  quantity      Int      @default(1)
  unitPrice     Int? // Unit price (integer for KRW precision)
  currency      String?  @default("KRW")
  lineTotal     Int? // Line total (unit price × quantity)
  leadTime      String? // 납기일 (AI 추출)
  position      Int? // 순서 (AI 추출 시 사용)
  notes         String?  @db.Text // 비고 (?도/?체품 ??/기존 ?품 코드 ??
  raw           Json? // Raw data snapshot (JSONB)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // 관?
  quote           Quote                     @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  product         Product?                  @relation(fields: [productId], references: [id], onDelete: Cascade)
  vendorResponses QuoteVendorResponseItem[] // Vendor responses for this item

  @@index([quoteId])
  @@index([productId])
}

// 기존 QuoteItem 모델 (?위 ?환????)
model QuoteItem {
  id        String   @id @default(cuid())
  quoteId   String
  productId String
  quantity  Int      @default(1)
  notes     String?  @db.Text
  createdAt DateTime @default(now())

  // 관?
  quote Quote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
  @@index([productId])
}

// QuoteStatus enum
enum QuoteStatus {
  PENDING // Pending
  PARSED // AI 파싱 완료 (확인 대기)
  SENT // Sent
  RESPONDED // Responded
  COMPLETED // Completed
  PURCHASED // Purchased (converted to PurchaseRecord)
  CANCELLED // Cancelled
}

// 견적 ?답
model QuoteResponse {
  id         String    @id @default(cuid())
  quoteId    String
  vendorId   String
  totalPrice Float?
  currency   String    @default("KRW")
  message    String?   @db.Text
  validUntil DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // 관?
  quote  Quote  @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  vendor Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([quoteId])
  @@index([vendorId])
}

// 벤더 과금 기록
model VendorBillingRecord {
  id          String    @id @default(cuid())
  vendorId    String
  type        String // "LEAD", "PREMIUM", "REPORT"
  amount      Float // 과금 금액
  quantity    Int? // 리드 ?? 리포??????
  description String?   @db.Text
  periodStart DateTime? // 과금 기간 ?작
  periodEnd   DateTime? // 과금 기간 종료
  createdAt   DateTime  @default(now())

  // 관?
  vendor Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([vendorId])
  @@index([createdAt])
}

// 즐겨찾기
model Favorite {
  id        String   @id @default(cuid())
  userId    String
  productId String
  createdAt DateTime @default(now())

  // 관?
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
}

// 검??기록
model SearchHistory {
  id               String           @id @default(cuid())
  userId           String?
  query            String
  intent           Json? // GPT 분류 결과
  category         ProductCategory?
  filters          Json? // ?용???터
  resultCount      Int?
  clickedProductId String?
  createdAt        DateTime         @default(now())

  // 관?
  user    User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [clickedProductId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([createdAt])
}

// ?품 추천 (AI 추천 결과 ???
model ProductRecommendation {
  id                   String   @id @default(cuid())
  productId            String
  recommendedProductId String
  score                Float // ?사???수
  reason               String?  @db.Text // 추천 근거
  reasonEn             String?  @db.Text
  createdAt            DateTime @default(now())

  // 관?
  product     Product                  @relation("ProductRecommendations", fields: [productId], references: [id], onDelete: Cascade)
  recommended Product                  @relation("RecommendedProducts", fields: [recommendedProductId], references: [id], onDelete: Cascade)
  feedbacks   RecommendationFeedback[]

  @@unique([productId, recommendedProductId])
  @@index([productId])
  @@index([score])
}

// 추천 ?질 ?드?
model RecommendationFeedback {
  id               String   @id @default(cuid())
  userId           String?
  recommendationId String
  isHelpful        Boolean // ?/?
  reason           String?  @db.Text // ???????유/?유 ?음
  createdAt        DateTime @default(now())

  // 관?
  recommendation ProductRecommendation @relation(fields: [recommendationId], references: [id], onDelete: Cascade)

  @@index([recommendationId])
  @@index([userId])
}

// ?품 리뷰??점
model Review {
  id        String   @id @default(cuid())
  userId    String
  productId String
  rating    Int // 1-5??
  title     String?
  comment   String?  @db.Text
  pros      String?  @db.Text // ?점
  cons      String?  @db.Text // ?점
  verified  Boolean  @default(false) // 구매 ?증 ??
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 관?
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId]) // ?용?당 ?품???나??리뷰?
  @@index([productId])
  @@index([userId])
  @@index([rating])
  @@index([createdAt])
}

// ?품 ?고 관?
model ProductInventory {
  id                   String    @id @default(cuid())
  userId               String? // ?용?별 ?고
  organizationId       String? // 조직??고
  productId            String
  currentQuantity      Float     @default(0) // ?재 ?고??
  unit                 String?   @default("ea") // (: mL, g)
  safetyStock          Float? // ?전 ?고 (???량 ?하??어지??주?추천)
  minOrderQty          Float? // 최소 주문 ?량
  location             String? // 보? ?치
  expiryDate           DateTime? // ?통기한
  autoReorderEnabled   Boolean   @default(false) // ?동 ?주??성????
  autoReorderThreshold Float? // ?동 ?주??계?(기본? safetyStock)
  notes                String?   @db.Text
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // 관?
  user         User?            @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization?    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  product      Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  usageRecords InventoryUsage[]

  @@unique([userId, productId]) // ?용?별 ?품???나???고 기록
  @@unique([organizationId, productId]) // 조직??품???나???고 기록
  @@index([productId])
  @@index([userId])
  @@index([organizationId])
  @@index([currentQuantity])
}

// ?고 ?용??기록 (?용??추정???한 ?이??
model InventoryUsage {
  id          String   @id @default(cuid())
  inventoryId String
  userId      String
  quantity    Float // ?용??
  unit        String? // ?위
  usageDate   DateTime @default(now()) // ?용 ?자
  notes       String?  @db.Text
  createdAt   DateTime @default(now())

  // 관?
  inventory ProductInventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([inventoryId])
  @@index([userId])
  @@index([usageDate])
}

// 공유 링크 (?냅??방식)
model SharedList {
  id          String    @id @default(cuid())
  quoteId     String // ?본 QuoteList ID
  publicId    String    @unique // 공유???수 ?큰
  title       String
  description String?   @db.Text
  snapshot    Json // ?냅???이??(?목 리스???체)
  createdBy   String? // ?성??ID (?션)
  expiresAt   DateTime? // 만료??(P1)
  isActive    Boolean   @default(true) // 비활?화 ??
  viewCount   Int       @default(0) // 조회 ??
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // 관?
  quote Quote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([publicId])
  @@index([quoteId])
  @@index([isActive])
}

// Purchase record (MVP: guestKey-based scope)
model PurchaseRecord {
  id            String   @id @default(cuid())
  scopeKey      String // guestKey for MVP, workspaceId for future
  workspaceId   String? // Optional workspace association
  quoteId       String? // Linked quote if source=quote
  purchasedAt   DateTime // Purchase date
  vendorName    String // Vendor name
  category      String? // Product category
  itemName      String // Item/product name
  catalogNumber String? // Catalog number
  unit          String? // Unit (ea, mL, g, etc.)
  qty           Int // Quantity
  unitPrice     Int? // Unit price (optional for import)
  amount        Int // Total amount (required)
  currency      String   @default("KRW")
  source        String   @default("import") // "import" or "quote"
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations (optional)
  quote     Quote?     @relation(fields: [quoteId], references: [id], onDelete: SetNull)
  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)

  @@index([scopeKey, purchasedAt])
  @@index([scopeKey, vendorName])
  @@index([scopeKey, category])
  @@index([quoteId])
  @@index([workspaceId])
}

// Budget management (MVP: guestKey-based scope)
model Budget {
  id          String   @id @default(cuid())
  scopeKey    String // guestKey for MVP, workspaceId for future
  workspaceId String? // Optional workspace association
  yearMonth   String // Format: "YYYY-MM" (e.g., "2025-01")
  amount      Int // Budget amount
  currency    String   @default("KRW")
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)

  @@unique([scopeKey, yearMonth])
  @@index([scopeKey])
  @@index([yearMonth])
  @@index([workspaceId])
}

// Import job tracking (for file-based imports)
enum ImportJobStatus {
  PENDING // Queued for processing
  PROCESSING // Currently processing
  COMPLETED // Successfully completed
  FAILED // Failed with errors
  PARTIAL // Partially completed with errors
}

model ImportJob {
  id           String          @id @default(cuid())
  scopeKey     String // guestKey for MVP
  workspaceId  String? // Optional workspace association
  type         String // "purchase" (expandable to other types)
  filename     String // Original filename
  status       ImportJobStatus @default(PENDING)
  totalRows    Int             @default(0)
  successRows  Int             @default(0)
  errorRows    Int             @default(0)
  errorSample  Json? // Array of error samples
  result       Json? // Import result metadata
  startedAt    DateTime?
  completedAt  DateTime?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  // Relations
  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)

  @@index([scopeKey])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@index([workspaceId])
}

// Workspace (minimal multi-tenant setup)
enum WorkspacePlan {
  FREE
  TEAM
  ENTERPRISE
}

enum WorkspaceMemberRole {
  ADMIN
  MEMBER
}

enum BillingStatus {
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELED
}

model Workspace {
  id               String   @id @default(cuid())
  name             String
  slug             String   @unique // URL-friendly identifier
  plan             WorkspacePlan @default(FREE)
  lastWorkspaceId  String? // For user's last active workspace

  // Stripe billing fields
  stripeCustomerId        String? @unique
  stripeSubscriptionId    String? @unique
  stripePriceId           String?
  stripeCurrentPeriodEnd  DateTime?
  billingStatus           BillingStatus?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  members          WorkspaceMember[]
  invites          WorkspaceInvite[]
  purchases        PurchaseRecord[]
  budgets          Budget[]
  quotes           Quote[]
  importJobs       ImportJob[]

  @@index([slug])
}

model WorkspaceMember {
  id          String   @id @default(cuid())
  workspaceId String
  userId      String
  role        WorkspaceMemberRole @default(MEMBER)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
}

model WorkspaceInvite {
  id          String    @id @default(cuid())
  workspaceId String
  token       String    @unique // Unique invite token
  email       String
  role        WorkspaceMemberRole @default(MEMBER)
  expiresAt   DateTime // Invite expiration
  acceptedAt  DateTime? // When invite was accepted
  createdAt   DateTime  @default(now())

  // Relations
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([workspaceId])
  @@index([email])
}

// 구독 정보 (Team/Org 플랜) - Production Level
model Subscription {
  id                   String           @id @default(cuid())
  organizationId       String?          @unique // 조직 기반 구독
  userId               String?          @unique // 개인 사용자 기반 구독
  workspaceId          String?          @unique // 워크스페이스 기반 구독
  plan                 SubscriptionPlan @default(FREE)
  status               String           @default("active") // active, trialing, past_due, canceled, unpaid
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean          @default(false)
  trialEndsAt          DateTime? // 체험판 종료일
  // Stripe 연동 필드
  stripeCustomerId     String? // Stripe 고객 ID
  stripeSubscriptionId String? // Stripe 구독 ID
  stripePriceId        String? // Stripe 가격 ID
  // 사용량 추적
  currentSeats         Int              @default(1) // 현재 시트 수
  maxSeats             Int? // 최대 시트 수 (플랜별 제한)
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt

  // 관계
  organization   Organization?   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoices       Invoice[] // 청구 내역
  paymentMethods PaymentMethod[] // 결제 수단

  @@index([organizationId])
  @@index([userId])
  @@index([workspaceId])
  @@index([status])
  @@index([stripeCustomerId])
}

// 결제 수단 (카드 정보)
model PaymentMethod {
  id             String   @id @default(cuid())
  subscriptionId String
  // Stripe 연동 필드
  stripePaymentMethodId String? @unique // Stripe PaymentMethod ID
  // 카드 정보 (표시용 - 실제 카드번호는 Stripe에 저장)
  brand          String? // visa, mastercard, amex 등
  last4          String? // 카드 마지막 4자리
  expMonth       Int? // 만료 월
  expYear        Int? // 만료 년
  // 상태
  isDefault      Boolean  @default(false) // 기본 결제 수단 여부
  isValid        Boolean  @default(true) // 유효 여부
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // 관계
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([isDefault])
}

// 청구서/인보이스
enum InvoiceStatus {
  DRAFT // 초안
  OPEN // 발행됨 (미결제)
  PAID // 결제 완료
  VOID // 취소됨
  UNCOLLECTIBLE // 수금 불가
}

model Invoice {
  id             String        @id @default(cuid())
  subscriptionId String
  // Stripe 연동 필드
  stripeInvoiceId String?      @unique // Stripe Invoice ID
  // 청구 정보
  number         String? // 청구서 번호 (예: INV-2024-001)
  status         InvoiceStatus @default(DRAFT)
  amountDue      Int // 청구 금액 (원)
  amountPaid     Int           @default(0) // 결제된 금액
  currency       String        @default("KRW")
  // 기간 정보
  periodStart    DateTime // 청구 기간 시작
  periodEnd      DateTime // 청구 기간 종료
  dueDate        DateTime? // 결제 기한
  paidAt         DateTime? // 결제 완료 시점
  // 상세 내역
  description    String?       @db.Text // 청구 설명
  lineItems      Json? // 세부 항목 [{description, quantity, unitPrice, amount}]
  // PDF 영수증
  invoicePdfUrl  String? // PDF 다운로드 URL
  hostedInvoiceUrl String? // Stripe 호스팅 인보이스 URL
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // 관계
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([status])
  @@index([periodStart])
  @@index([stripeInvoiceId])
}

// 액티비티 로그 (P1+)
enum ActivityType {
  QUOTE_CREATED // 리스트 생성
  QUOTE_UPDATED // 리스트 수정
  QUOTE_DELETED // 리스트 삭제
  QUOTE_SHARED // 리스트 공유
  QUOTE_VIEWED // 리스트 조회
  QUOTE_STATUS_CHANGED // 견적 상태 변경
  PRODUCT_COMPARED // 제품 비교
  PRODUCT_VIEWED // 제품 조회
  PRODUCT_FAVORITED // 제품 즐겨찾기
  SEARCH_PERFORMED // 검색 수행
}

model ActivityLog {
  id             String       @id @default(cuid())
  userId         String? // 사용자 ID (비로그인 사용자는 null)
  organizationId String? // 조직 ID
  activityType   ActivityType // 활동 유형
  entityType     String // 엔티티 유형 (quote, product, search 등)
  entityId       String? // 엔티티 ID
  metadata       Json? // 추가 메타데이터 (JSON)
  ipAddress      String? // IP 주소
  userAgent      String? // User Agent
  createdAt      DateTime     @default(now())

  // 관계
  user         User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([organizationId])
  @@index([activityType])
  @@index([entityType])
  @@index([entityId])
  @@index([createdAt])
}

// 감사 로그 (Enterprise - 액티비티 로그 확장)
enum AuditEventType {
  USER_LOGIN // 사용자 로그인
  USER_LOGOUT // 사용자 로그아웃
  USER_CREATED // 사용자 생성
  USER_UPDATED // 사용자 수정
  USER_DELETED // 사용자 삭제
  PERMISSION_CHANGED // 권한 변경
  SETTINGS_CHANGED // 설정 변경
  DATA_EXPORTED // 데이터 내보내기
  DATA_IMPORTED // 데이터 가져오기
  SSO_CONFIGURED // SSO 설정
  ORGANIZATION_CREATED // 조직 생성
  ORGANIZATION_UPDATED // 조직 수정
  ORGANIZATION_DELETED // 조직 삭제
}

model AuditLog {
  id             String         @id @default(cuid())
  organizationId String? // 조직 ID (Enterprise)
  userId         String? // 사용자 ID
  eventType      AuditEventType // 이벤트 유형
  entityType     String // 엔티티 유형
  entityId       String? // 엔티티 ID
  action         String // 액션 (create, update, delete, view 등)
  changes        Json? // 변경 사항 (before/after)
  metadata       Json? // 추가 메타데이터
  ipAddress      String? // IP 주소
  userAgent      String? // User Agent
  success        Boolean        @default(true) // 성공 여부
  errorMessage   String?        @db.Text // 오류 메시지
  createdAt      DateTime       @default(now())

  // 관계
  user         User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([userId])
  @@index([eventType])
  @@index([entityType])
  @@index([entityId])
  @@index([createdAt])
  @@index([success])
}

// RFQ Token for email-based quote replies
model QuoteRfqToken {
  id        String    @id @default(cuid())
  quoteId   String    @unique // One token per quote
  token     String    @unique // URL-safe random token (32-48 chars)
  enabled   Boolean   @default(true) // Can disable without deleting
  expiresAt DateTime? // Optional expiration
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  quote Quote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([enabled])
}

// Inbound email status
enum InboundEmailStatus {
  MATCHED // Successfully matched to a quote
  UNMATCHED // No matching token found
  FAILED // Processing error
}

// Inbound email log (for webhook processing)
model InboundEmail {
  id              String             @id @default(cuid())
  provider        String             @default("sendgrid") // Email provider
  messageId       String             @unique // Email Message-ID for deduplication
  to              String // Recipient address
  from            String // Sender address
  subject         String
  text            String?            @db.Text // Plain text body
  html            String?            @db.Text // HTML body
  rawHeaders      Json? // Raw email headers
  attachmentsMeta Json? // Attachment metadata
  matchedQuoteId  String? // Matched quote (if status=MATCHED)
  status          InboundEmailStatus @default(UNMATCHED)
  receivedAt      DateTime           @default(now())
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  // Relations
  matchedQuote Quote? @relation(fields: [matchedQuoteId], references: [id], onDelete: SetNull)

  @@index([messageId])
  @@index([status])
  @@index([matchedQuoteId])
  @@index([receivedAt])
}

// Quote reply from vendor (via email)
model QuoteReply {
  id          String   @id @default(cuid())
  quoteId     String
  vendorName  String? // Nullable, can be extracted from email
  fromEmail   String // Sender email
  subject     String
  receivedAt  DateTime @default(now())
  bodyText    String?  @db.Text // Plain text body
  bodyHtml    String?  @db.Text // HTML body
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  quote       Quote                 @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  attachments QuoteReplyAttachment[]

  @@index([quoteId])
  @@index([fromEmail])
  @@index([receivedAt])
}

// Attachments for quote replies
model QuoteReplyAttachment {
  id          String   @id @default(cuid())
  replyId     String
  fileName    String
  contentType String?
  sizeBytes   Int
  bucket      String // Supabase storage bucket name
  path        String // Storage path
  createdAt   DateTime @default(now())

  // Relations
  reply QuoteReply @relation(fields: [replyId], references: [id], onDelete: Cascade)

  @@index([replyId])
}

// Vendor information for quotes (optional, can be added later)
model QuoteVendor {
  id          String   @id @default(cuid())
  quoteId     String
  vendorName  String
  email       String?
  country     String?  @default("KR")
  memo        String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  quote Quote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
  @@index([vendorName])
}

// Public share configuration for quotes (optional for phase B)
model QuoteShare {
  id          String    @id @default(cuid())
  quoteId     String    @unique // One share per quote
  shareToken  String    @unique // URL-safe random token for public access
  expiresAt   DateTime? // Optional expiration
  enabled     Boolean   @default(true) // Can disable without deleting
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  quote Quote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([shareToken])
  @@index([enabled])
}

// Vendor request status enum
enum VendorRequestStatus {
  SENT       // Initial state after sending
  RESPONDED  // Vendor has submitted response
  EXPIRED    // Past expiration date
  CANCELLED  // Cancelled by internal user
}

// Vendor request (견적 요청 발송 단위)
model QuoteVendorRequest {
  id                String              @id @default(cuid())
  quoteId           String // FK to Quote (견적요청서)
  vendorName        String? // Optional vendor name
  vendorEmail       String // Required vendor email
  message           String?             @db.Text // Request message
  token             String              @unique // Public access token (32-48 chars random)
  status            VendorRequestStatus @default(SENT)
  expiresAt         DateTime // Default 14 days from creation
  respondedAt       DateTime? // When vendor submitted response (initial submission)
  responseEditCount Int                 @default(0) // Number of times response was edited
  responseEditLimit Int                 @default(1) // Maximum allowed edits
  snapshot          Json // Frozen snapshot of quote + items at request time
  snapshotCreatedAt DateTime            @default(now()) // When snapshot was taken
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  // Relations
  quote         Quote                      @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  responseItems QuoteVendorResponseItem[]

  @@index([quoteId])
  @@index([token])
  @@index([status])
  @@index([expiresAt])
}

// Vendor response item (품목별 회신)
model QuoteVendorResponseItem {
  id               String   @id @default(cuid())
  vendorRequestId  String // FK to QuoteVendorRequest
  quoteItemId      String // FK to QuoteListItem
  unitPrice        Int? // Response unit price (KRW precision)
  currency         String   @default("KRW")
  leadTimeDays     Int? // Lead time in days
  moq              Int? // Minimum order quantity (optional)
  vendorSku        String? // Vendor's SKU/catalog number (optional)
  notes            String?  @db.Text // Vendor notes (optional)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  vendorRequest QuoteVendorRequest @relation(fields: [vendorRequestId], references: [id], onDelete: Cascade)
  quoteItem     QuoteListItem      @relation(fields: [quoteItemId], references: [id], onDelete: Cascade)

  @@unique([vendorRequestId, quoteItemId])
  @@index([vendorRequestId])
  @@index([quoteItemId])
}
